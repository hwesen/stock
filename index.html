<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æŠ•è³‡è³‡è¨Š BI Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f5f7fa; margin: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .filters { text-align: center; margin-bottom: 20px; }
    select { margin: 0 10px; padding: 5px; }
    #market-summary { text-align:center; font-weight:bold; margin-bottom:20px; font-size: 18px; }
    .kpi-container { display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap; gap: 10px; }
    .kpi { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; width: 22%; min-width: 180px; }
    .news-container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 30px; }
    .news-item { margin-bottom: 10px; }
    .news-item a { text-decoration: none; color: #0077cc; }
  </style>
</head>
<body>

<h1>ğŸ“Š æŠ•è³‡è³‡è¨Š BI Dashboard</h1>

<!-- ç¯©é¸å™¨ -->
<div class="filters">
  <label for="companyFilter">é¸æ“‡å…¬å¸ï¼š</label>
  <select id="companyFilter" onchange="applyFilter()">
    <option value="All">All</option>
    <option value="Alibaba">Alibaba</option>
    <option value="Nvidia">Nvidia</option>
    <option value="UnitedHealth">UnitedHealth</option>
    <option value="Tesla">Tesla</option>
  </select>

  <label for="dateFilter">æ—¥æœŸç¯„åœï¼š</label>
  <select id="dateFilter" onchange="applyFilter()">
    <option value="All">å…¨éƒ¨</option>
    <option value="7">æœ€è¿‘ 7 å¤©</option>
    <option value="30">æœ€è¿‘ 30 å¤©</option>
  </select>
</div>

<!-- å¤§ç›¤ Summary -->
<div id="market-summary">å¤§ç›¤ç‹€æ…‹è¼‰å…¥ä¸­...</div>

<!-- KPI èˆ‡åœ–è¡¨ -->
<div class="kpi-container" id="kpi-cards"></div>
<canvas id="stockChart" height="100"></canvas>

<!-- æ–°è -->
<div class="news-container">
  <h2>æœ€æ–°æ¶ˆæ¯</h2>
  <div id="news-list"></div>
</div>

<script>
  const sheetId = "16Ez6rBX12fI0zm7EIz01UQiiXRNWDBtJwH65TlWiPI0"; // ä½ çš„ Google Sheet ID

  let allStockData = null;
  let allNewsData = null;
  let stockChart = null;

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(loadData);

  async function loadData() {
    await loadStocks();
    await loadNews();
  }

  // æŠ“è‚¡åƒ¹
  function loadStocks() {
    const query = new google.visualization.Query(
      `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=stocks&range=A:F`
    );
    query.send(response => {
      allStockData = response.getDataTable();
      renderStocks("All", "All");
    });
  }

  function renderStocks(filterCompany, filterDays) {
    const data = allStockData;
    const numRows = data.getNumberOfRows();

    let labels = [];
    let datasetsMap = {};
    let lastValues = {};
    let cutoffDate = null;
    let spyRegime = "N/A";

    if (filterDays !== "All") {
      cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - parseInt(filterDays));
    }

    for (let i = 0; i < numRows; i++) {
      const dateStr = data.getValue(i, 0);
      const company = data.getValue(i, 1);
      const close = data.getValue(i, 3);
      const changePct = data.getValue(i, 5);

      const rowDate = new Date(dateStr);

      if (filterCompany !== "All" && company !== filterCompany) continue;
      if (cutoffDate && rowDate < cutoffDate) continue;

      if (!datasetsMap[company]) datasetsMap[company] = [];
      datasetsMap[company].push(close);

      if (!labels.includes(dateStr)) labels.push(dateStr);

      lastValues[company] = { close, changePct };

      // å¤§ç›¤åˆ¤æ–·ï¼ˆåªå° SPY åš SMA200ï¼‰
      if (company === "SPY" && datasetsMap[company].length >= 200) {
        const closes = datasetsMap[company].slice(-200);
        const sma200 = closes.reduce((a,b)=>a+b,0)/closes.length;
        spyRegime = close > sma200 ? "BULL" : "BEAR";
      }
    }

    // === æ›´æ–°å¤§ç›¤ Summary ===
    document.getElementById("market-summary").innerText = 
      `å¤§ç›¤ (SPY) ç‹€æ…‹ï¼š${spyRegime}`;

    // === KPI Cards ===
    const kpiContainer = document.getElementById("kpi-cards");
    kpiContainer.innerHTML = "";
    for (const company in lastValues) {
      if (company === "SPY") continue; // ä¸æŠŠSPYé¡¯ç¤ºåœ¨KPI
      const { close, changePct } = lastValues[company];
      const kpi = document.createElement("div");
      kpi.className = "kpi";
      kpi.innerHTML = `<h2>${company}</h2>
                       <p>$${close} ${changePct > 0 ? "â–²" : "â–¼"}${changePct.toFixed(2)}%</p>`;
      kpiContainer.appendChild(kpi);
    }

    // === Chart ===
    if (stockChart) stockChart.destroy();
    const ctx = document.getElementById('stockChart');
    stockChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: Object.keys(datasetsMap)
          .filter(c => c !== "SPY") // åœ–è¡¨åªç•«å€‹è‚¡
          .map((company, idx) => ({
            label: company,
            data: datasetsMap[company],
            borderColor: ["red","green","blue","orange"][idx % 4],
            fill: false
          }))
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  // æŠ“æ–°è
  function loadNews() {
    const query = new google.visualization.Query(
      `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=news&range=A:E`
    );
    query.send(response => {
      allNewsData = response.getDataTable();
      renderNews("All", "All");
    });
  }

  function renderNews(filterCompany, filterDays) {
    const data = allNewsData;
    const numRows = data.getNumberOfRows();
    const newsList = document.getElementById("news-list");
    newsList.innerHTML = "";

    let cutoffDate = null;
    if (filterDays !== "All") {
      cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - parseInt(filterDays));
    }

    for (let i = 0; i < numRows; i++) {
      const company = data.getValue(i, 1);
      const title = data.getValue(i, 2);
      const link = data.getValue(i, 3);
      const pubDateStr = data.getValue(i, 4);
      const pubDate = new Date(pubDateStr);

      if (filterCompany !== "All" && company !== filterCompany) continue;
      if (cutoffDate && pubDate < cutoffDate) continue;

      const item = document.createElement("div");
      item.className = "news-item";
      item.innerHTML = `<b>${company}</b>: <a href="${link}" target="_blank">${title}</a>`;
      newsList.appendChild(item);
    }
  }

  // ç¯©é¸å™¨å¥—ç”¨
  function applyFilter() {
    const company = document.getElementById("companyFilter").value;
    const days = document.getElementById("dateFilter").value;
    renderStocks(company, days);
    renderNews(company, days);
  }
</script>

</body>
</html>
