<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æŠ•è³‡è³‡è¨Š BI Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; margin: 20px; background:#f5f7fa; color:#111; }
    h1 { text-align:center; margin:10px 0 20px; }
    #spySummary, #summary, .analysis, .news {
      max-width:1000px;
      margin:0 auto 24px;
      padding:16px 20px;
      border-radius:12px;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    #spySummary h2, #summary h2, .analysis h2, .news h2 { margin:0 0 12px; text-align:center; }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:16px;
      margin-top:12px;
    }
    .card {
      background:#fafafa;
      border-radius:10px;
      padding:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
    }
    .card h3 { margin:0 0 8px; font-size:16px; }
    .analysis p, .news p { margin:6px 0; line-height:1.5; }
    .stock-title { font-weight:bold; color:#333; }
    .news a { color:#0077cc; text-decoration:none; }
    .news a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <h1>ğŸ“Š æŠ•è³‡è³‡è¨Š BI Dashboard</h1>

  <!-- å¤§ç›¤ Summary -->
  <div id="spySummary">
    <h2>ğŸ“ˆ å¤§ç›¤ (SPY) ç‹€æ…‹</h2>
    <div id="spyContent">è¼‰å…¥ä¸­...</div>
  </div>

  <!-- å€‹è‚¡å»ºè­° -->
  <div id="summary">
    <h2>ğŸ’¡ ä»Šæ—¥å€‹è‚¡å»ºè­°</h2>
    <div class="grid" id="stockGrid">è¼‰å…¥ä¸­...</div>
  </div>

  <!-- åˆ†æèªªæ˜ -->
  <div class="analysis">
    <h2>ğŸ“Š åˆ†æèªªæ˜</h2>
    <div id="analysisContent">è¼‰å…¥ä¸­...</div>
  </div>

  <!-- æ–°èæ‘˜è¦ -->
  <div class="news">
    <h2>ğŸ“° æœ€æ–°æ¶ˆæ¯æ‘˜è¦</h2>
    <div id="newsContent">è¼‰å…¥ä¸­...</div>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwTihz3-zh_A-sOX9yhRehETUNqsgOFCAQljpKRfj7R5P6SSUpyJezo9bremy7JiYkyWQ/exec"; 
    // â†‘ æ›æˆä½ éƒ¨ç½²å¥½çš„ Apps Script WebApp URL

    async function loadSignals() {
      try {
        const res = await fetch(WEBAPP_URL + "?type=signals");
        const stocks = await res.json();

        const spyDiv = document.getElementById("spyContent");
        const grid = document.getElementById("stockGrid");
        const analysisDiv = document.getElementById("analysisContent");

        spyDiv.innerHTML = "";
        grid.innerHTML = "";
        analysisDiv.innerHTML = "";

        stocks.forEach(stock => {
          if (stock.symbol === "SPY") {
            let regimeIcon = "â¸ï¸";
            if (stock.regime === "BULL") regimeIcon = "ğŸ“ˆ";
            if (stock.regime === "BEAR") regimeIcon = "ğŸ“‰";

            spyDiv.innerHTML = `<p>
              æ—¥æœŸï¼š${stock.date} ï½œ ç‹€æ…‹ï¼š${regimeIcon} <b>${stock.regime}</b> ï½œ 
              ç¾åƒ¹ <span style="color:#0077cc;">${stock.entry}</span> ï½œ 
              æ¼²è·Œå¹…ï¼š<span style="color:${stock.changePct >= 0 ? '#5cb85c':'#d9534f'};">${stock.changePct}%</span>
            </p>`;
          } else {
            // å€‹è‚¡å¡ç‰‡
            const card = document.createElement("div");
            card.className = "card";

            let extraFields = "";
            if (stock.signal === "BUY") {
              extraFields = `
                <p><span style="color:#0077cc;">Entryï¼š${stock.entry || '-'}</span></p>
                <p><span style="color:#d9534f;">Stopï¼š${stock.stop || '-'}</span></p>
                <p><span style="color:#5cb85c;">TPï¼š${stock.takeProfit || '-'}</span></p>
                <p>å»ºè­°å€‰ä½ï¼š${stock.shares || '-'} è‚¡</p>
                <p>æ¼²è·Œå¹…ï¼š<span style="color:${stock.changePct >= 0 ? '#5cb85c':'#d9534f'};">${stock.changePct}%</span></p>
              `;
            } else if (stock.signal === "SELL") {
              extraFields = `
                <p><span style="color:#0077cc;">ç¾åƒ¹ï¼š${stock.entry || '-'}</span></p>
                <p><span style="color:#5cb85c;">åœåˆ©ï¼š${stock.takeProfit || '-'}</span></p>
                <p><span style="color:#d9534f;">åœæï¼š${stock.stop || '-'}</span></p>
                <p>æ¼²è·Œå¹…ï¼š<span style="color:${stock.changePct >= 0 ? '#5cb85c':'#d9534f'};">${stock.changePct}%</span></p>
              `;
            } else {
              extraFields = `
                <p><span style="color:#0077cc;">ç¾åƒ¹ï¼š${stock.entry || '-'}</span></p>
                <p>æ¼²è·Œå¹…ï¼š<span style="color:${stock.changePct >= 0 ? '#5cb85c':'#d9534f'};">${stock.changePct}%</span></p>
              `;
            }

            card.innerHTML = `
              <h3>${stock.symbol}</h3>
              <p>Signalï¼š${stock.signal}</p>
              <p>Regimeï¼š${stock.regime}</p>
              ${extraFields}
              <canvas id="chart-${stock.symbol}" height="100"></canvas>
            `;
            grid.appendChild(card);

            // å‡ç·šåœ–
            const ctx = document.getElementById(`chart-${stock.symbol}`);
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ["SMA20","SMA50","SMA200"],
                datasets: [{
                  label: "å‡ç·šå€¼",
                  data: [stock.sma20, stock.sma50, stock.sma200],
                  backgroundColor: "rgba(75,192,192,0.5)"
                }]
              },
              options: { responsive: true, plugins:{ legend:{display:false} } }
            });

            // åˆ†æèªªæ˜
            let text = "";
            switch(stock.signal) {
              case "HOLD":
                text = `â¸ï¸ ${stock.symbol} ç¾åƒ¹ <span style="color:#0077cc;">${stock.entry}</span>ï¼Œ
                  æ¼²è·Œå¹… <span style="color:${stock.changePct >= 0 ? '#5cb85c':'#d9534f'};">${stock.changePct}%</span>ï¼Œ
                  è™•æ–¼ ${stock.regime} è¶¨å‹¢ï¼Œæš«ç„¡çªç ´è¨Šè™Ÿï¼Œå»ºè­°æŒæœ‰è§€æœ›ã€‚`;
                break;
              case "BUY":
                text = `ğŸ“ˆ ${stock.symbol} å‡ºç¾è²·é€²è¨Šè™Ÿï¼ˆRSI=${stock.rsi}ï¼‰ï¼Œ
                  é€²å ´ <span style="color:#0077cc;">${stock.entry}</span>ï¼Œ
                  åœæ <span style="color:#d9534f;">${stock.stop}</span>ï¼Œ
                  ç›®æ¨™ <span style="color:#5cb85c;">${stock.takeProfit}</span>ï¼Œ
                  å»ºè­°å€‰ä½ ${stock.shares || '-'} è‚¡ï¼Œ
                  ç•¶æ—¥æ¼²è·Œå¹… <span style="color:${stock.changePct >= 0 ? '#5cb85c':'#d9534f'};">${stock.changePct}%</span>ã€‚`;
                break;
              case "SELL":
                text = `ğŸ“‰ ${stock.symbol} å‡ºç¾è³£å‡ºè¨Šè™Ÿï¼Œ
                  ç¾åƒ¹ <span style="color:#0077cc;">${stock.entry}</span>ï¼Œ
                  åœåˆ© <span style="color:#5cb85c;">${stock.takeProfit}</span>ï¼Œ
                  åœæ <span style="color:#d9534f;">${stock.stop}</span>ï¼Œ
                  ç•¶æ—¥æ¼²è·Œå¹… <span style="color:${stock.changePct >= 0 ? '#5cb85c':'#d9534f'};">${stock.changePct}%</span>ã€‚`;
                break;
              default:
                text = `${stock.symbol} ç„¡æ˜ç¢ºè¨Šè™Ÿã€‚`;
            }
            if (stock.note) text += `ï¼ˆ${stock.note}ï¼‰`;
            const p = document.createElement("p");
            p.innerHTML = `<span class="stock-title">${stock.symbol}ï¼š</span> ${text}`;
            analysisDiv.appendChild(p);
          }
        });

      } catch (err) {
        document.getElementById("spyContent").innerText = "âš ï¸ ç„¡æ³•è¼‰å…¥ SPY è³‡æ–™";
        document.getElementById("stockGrid").innerText = "âš ï¸ ç„¡æ³•è¼‰å…¥å€‹è‚¡è³‡æ–™";
        document.getElementById("analysisContent").innerText = "âš ï¸ ç„¡æ³•è¼‰å…¥åˆ†æ";
        console.error(err);
      }
    }

    async function loadNews() {
      try {
        const res = await fetch(WEBAPP_URL + "?type=news");
        const news = await res.json();
        const newsDiv = document.getElementById("newsContent");
        newsDiv.innerHTML = "";

        news.slice(0, 10).forEach(item => {
          const p = document.createElement("p");
          const a = document.createElement("a");
          a.href = item.url;
          a.target = "_blank";
          a.innerText = `[${item.source}] ${item.title}`;
          p.appendChild(a);
          if (item.summary) {
            const span = document.createElement("span");
            span.innerText = " - " + item.summary;
            p.appendChild(span);
          }
          newsDiv.appendChild(p);
        });
      } catch (err) {
        document.getElementById("newsContent").innerText = "âš ï¸ ç„¡æ³•è¼‰å…¥æ–°è";
        console.error(err);
      }
    }

    // åˆå§‹åŒ–
    loadSignals();
    loadNews();
  </script>
</body>
</html>
