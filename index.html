<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>投資資訊 BI Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; margin: 20px; background:#f5f7fa; color:#111; }
    h1 { text-align:center; margin:10px 0 20px; }
    #spySummary, #summary, .analysis, .news {
      max-width:1000px;
      margin:0 auto 24px;
      padding:16px 20px;
      border-radius:12px;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    #spySummary h2, #summary h2, .analysis h2, .news h2 { margin:0 0 12px; text-align:center; }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:16px;
      margin-top:12px;
    }
    .card {
      background:#fafafa;
      border-radius:10px;
      padding:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
    }
    .card h3 { margin:0 0 8px; font-size:16px; }
    .analysis p, .news p { margin:6px 0; line-height:1.5; }
    .stock-title { font-weight:bold; color:#333; }
    .news a { color:#0077cc; text-decoration:none; }
    .news a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <h1>📊 投資資訊 BI Dashboard</h1>

  <!-- 大盤 Summary -->
  <div id="spySummary">
    <h2>📈 大盤 (SPY) 狀態</h2>
    <div id="spyContent">載入中...</div>
  </div>

  <!-- 個股建議 -->
  <div id="summary">
    <h2>💡 今日個股建議</h2>
    <div class="grid" id="stockGrid">載入中...</div>
  </div>

  <!-- 分析說明 -->
  <div class="analysis">
    <h2>📊 分析說明</h2>
    <div id="analysisContent">載入中...</div>
  </div>

  <!-- 新聞摘要 -->
  <div class="news">
    <h2>📰 最新消息摘要</h2>
    <div id="newsContent">載入中...</div>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwTihz3-zh_A-sOX9yhRehETUNqsgOFCAQljpKRfj7R5P6SSUpyJezo9bremy7JiYkyWQ/exec"; 
    // ↑ 換成你部署好的 Apps Script WebApp URL

    async function loadSignals() {
      try {
        const res = await fetch(WEBAPP_URL + "?type=signals");
        const stocks = await res.json();

        const spyDiv = document.getElementById("spyContent");
        const grid = document.getElementById("stockGrid");
        const analysisDiv = document.getElementById("analysisContent");

        spyDiv.innerHTML = "";
        grid.innerHTML = "";
        analysisDiv.innerHTML = "";

        stocks.forEach(stock => {
          if (stock.symbol === "SPY") {
            spyDiv.innerHTML = `<p>日期：${stock.date} ｜ 狀態：<b>${stock.regime}</b></p>`;
          } else {
            // 個股卡片
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h3>${stock.symbol}</h3>
              <p>Signal：${stock.signal}</p>
              <p>Regime：${stock.regime}</p>
              <p>Entry：${stock.entry || '-'}</p>
              <p>Stop：${stock.stop || '-'}</p>
              <p>TP：${stock.takeProfit || '-'}</p>
              <canvas id="chart-${stock.symbol}" height="100"></canvas>
            `;
            grid.appendChild(card);

            // 均線圖
            const ctx = document.getElementById(`chart-${stock.symbol}`);
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ["SMA20","SMA50","SMA200"],
                datasets: [{
                  label: "均線值",
                  data: [stock.sma20, stock.sma50, stock.sma200],
                  backgroundColor: "rgba(75,192,192,0.5)"
                }]
              },
              options: { responsive: true, plugins:{ legend:{display:false} } }
            });

            // 分析說明
            let text = "";
            switch(stock.signal) {
  case "HOLD":
    text = `${stock.symbol} 現價 ${stock.entry}，處於 ${stock.regime} 趨勢，暫無突破訊號，建議持有觀望。`;
    break;
  case "BUY":
    text = `${stock.symbol} 出現買進訊號（RSI=${stock.rsi}），建議進場 ${stock.entry}，停損 ${stock.stop}，目標 ${stock.takeProfit}，建議倉位 ${stock.shares || '-'} 股。`;
    break;
  case "SELL":
    text = `${stock.symbol} 出現賣出訊號，現價 ${stock.entry}，建議停利 ${stock.takeProfit}、停損 ${stock.stop}。`;
    break;
  default:
    text = `${stock.symbol} 無明確訊號。`;
}

        });

      } catch (err) {
        document.getElementById("spyContent").innerText = "⚠️ 無法載入 SPY 資料";
        document.getElementById("stockGrid").innerText = "⚠️ 無法載入個股資料";
        document.getElementById("analysisContent").innerText = "⚠️ 無法載入分析";
        console.error(err);
      }
    }

  async function loadNews() {
  try {
    const res = await fetch(WEBAPP_URL + "?type=news");
    let news = await res.json();
    const newsDiv = document.getElementById("newsContent");
    newsDiv.innerHTML = "";

    // 先顯示前 10 筆
    const initialNews = news.slice(0, 10);
    renderNews(initialNews, newsDiv);

    // 如果超過 10 筆，加上「查看更多」按鈕
    if (news.length > 10) {
      const btn = document.createElement("button");
      btn.innerText = "查看更多";
      btn.style.marginTop = "12px";
      btn.style.padding = "8px 16px";
      btn.style.border = "none";
      btn.style.borderRadius = "6px";
      btn.style.background = "#0077cc";
      btn.style.color = "#fff";
      btn.style.cursor = "pointer";

      btn.addEventListener("click", () => {
        // 顯示剩下的新聞
        const moreNews = news.slice(10);
        renderNews(moreNews, newsDiv);
        btn.remove(); // 點擊後移除按鈕
      });

      newsDiv.appendChild(btn);
    }
  } catch (err) {
    document.getElementById("newsContent").innerText = "⚠️ 無法載入新聞";
    console.error(err);
  }
}

// 共用函式：渲染新聞
function renderNews(items, container) {
  items.forEach(item => {
    const p = document.createElement("p");
    const a = document.createElement("a");
    a.href = item.url;
    a.target = "_blank";
    a.innerText = `[${item.source}] ${item.title}`;
    p.appendChild(a);

    if (item.summary) {
      const span = document.createElement("span");
      span.innerText = " - " + item.summary;
      p.appendChild(span);
    }
    container.appendChild(p);
  });
}


    // 初始化
    loadSignals();
    loadNews();
  </script>
</body>
</html>
