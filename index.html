<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>股票監控看板</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --card-gap: 20px; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; color:#111; }
    h1 { text-align:center; margin: 10px 0 12px; }
    #summary { text-align:center; font-weight:600; margin-bottom:20px; color:#333; }
    .grid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--card-gap);
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 28px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    .card {
      border: 1px solid #ddd; border-radius: 8px; padding: 10px;
      background: #fff; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,.04);
    }
    .price-line { margin-top: 6px; font-weight: 600; }
    .signal-line { margin-top: 2px; font-size: 12px; color:#555; }
    canvas { width: 100% !important; height: 200px !important; }
    #news { max-width: 1000px; margin: 30px auto; }
    #news h2 { margin: 8px 0 12px; }
    .news-item { padding: 10px 0; border-bottom: 1px solid #eee; }
    .news-item a { color:#2257d1; font-weight:700; text-decoration:none; }
    .news-meta { color:#666; font-size:12px; margin-top: 2px; }
    .summary { color:#222; margin-top: 4px; }
    .toolbar { max-width: 1200px; margin: 0 auto 12px; display:flex; gap:10px; justify-content:flex-end; }
    .btn {
      border:1px solid #ccc; padding:6px 10px; border-radius:6px; background:#fafafa; cursor:pointer;
    }
    .btn:hover { background:#f0f0f0; }
  </style>
</head>
<body>
  <h1>股票監控看板</h1>
  <div id="summary">今日建議：讀取中...</div>

  <div class="toolbar">
    <button class="btn" id="refreshBtn">重新整理</button>
  </div>

  <div class="grid" id="cards"></div>

  <section id="news">
    <h2>最新消息摘要</h2>
    <div id="news-list"></div>
  </section>

<script>
const SHEET_ID = "在這裡填入你的試算表ID";
const SYMBOLS  = ["BABA","UNH","TSLA","NVDA"];
const pricesCSV  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Prices`;
const newsCSV    = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=News`;
const signalsCSV = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Signals`;

function buildCards(){
  const wrap = document.getElementById('cards');
  wrap.innerHTML = SYMBOLS.map(sym => `
    <div class="card">
      <canvas id="chart-${sym}"></canvas>
      <div class="price-line">${sym}: <span id="price-${sym}">—</span></div>
      <div class="signal-line" id="signal-${sym}">建議：—</div>
    </div>
  `).join('');
}

async function csv(url){
  const text = await (await fetch(url, {cache:'no-store'})).text();
  return text.trim().split('\n').map(row =>
    row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s => s.replace(/^"|"$/g,''))
  );
}

async function drawCharts(){
  const rows = await csv(pricesCSV);
  if (!rows.length) return;
  const data = rows.slice(1);

  const grouped = {};
  for (const r of data){
    const [symbol,date,price,open,high,low,prevClose,volume] = r;
    if (!SYMBOLS.includes(symbol)) continue;
    if (!grouped[symbol]) grouped[symbol] = {dates:[], closes:[], highs:[], lows:[]};
    grouped[symbol].dates.push(date);
    grouped[symbol].closes.push(parseFloat(price));
    grouped[symbol].highs.push(parseFloat(high));
    grouped[symbol].lows.push(parseFloat(low));
  }

  SYMBOLS.forEach(sym=>{
    const g = grouped[sym];
    if (!g) return;
    const labels = g.dates.slice(-30);
    const closes = g.closes.slice(-30);
    const highs  = g.highs.slice(-30);
    const lows   = g.lows.slice(-30);
    const sma20  = calcSMA(closes,20);

    const lastClose = closes[closes.length-1];
    document.getElementById(`price-${sym}`).textContent = lastClose.toFixed(2);

    const ctx = document.getElementById(`chart-${sym}`).getContext('2d');
    new Chart(ctx,{
      data:{
        labels,
        datasets:[
          {
            type:'line',
            label:`${sym} High-Low`,
            data: highs.map((h,i)=>({y:h,yMin:lows[i]})), // plugin 會用
            borderColor:'rgba(0,0,0,0)',
            backgroundColor:'rgba(200,200,200,0.3)',
            fill:true,
            parsing:false,
            yAxisID:'y'
          },
          {
            type:'bar',
            label:`${sym} Close`,
            data: closes,
            backgroundColor:'rgba(30,144,255,0.6)',
            yAxisID:'y'
          },
          {
            type:'line',
            label:`${sym} SMA20`,
            data: sma20,
            borderColor:'red',
            borderWidth:2,
            pointRadius:0,
            yAxisID:'y'
          }
        ]
      },
      options:{
        plugins:{ legend:{display:false} },
        responsive:true,
        maintainAspectRatio:false,
        scales:{ y:{ title:{display:true,text:'股價'} } },
        elements: {
          line: { tension:0 }
        }
      },
      plugins:[{
        id:'hlBand',
        beforeDatasetDraw(chart,args,opts){
          if(args.index===0){
            const {ctx, chartArea:{top,bottom}, scales:{x,y}} = chart;
            ctx.save();
            const meta = chart.getDatasetMeta(args.index);
            meta.data.forEach((pt,i)=>{
              const h = chart.data.datasets[0].data[i].y;
              const l = chart.data.datasets[0].data[i].yMin;
              const xC = pt.x;
              ctx.beginPath();
              ctx.strokeStyle='rgba(180,180,180,0.5)';
              ctx.moveTo(xC, y.getPixelForValue(h));
              ctx.lineTo(xC, y.getPixelForValue(l));
              ctx.stroke();
            });
            ctx.restore();
          }
        }
      }]
    });
  });
}

function calcSMA(arr,n){
  const out=new Array(arr.length).fill(null);
  for(let i=n-1;i<arr.length;i++){
    let sum=0;
    for(let j=0;j<n;j++) sum+=arr[i-j];
    out[i]=sum/n;
  }
  return out;
}

async function drawSignals(){
  const rows = await csv(signalsCSV);
  if (!rows.length) return;
  const header = rows[0];
  const idx = Object.fromEntries(header.map((k,i)=>[k,i]));
  const data = rows.slice(1);
  const latest = {};
  data.forEach(r=>{
    const sym = r[idx.Symbol];
    if (!SYMBOLS.includes(sym)) return;
    if (!latest[sym] || r[idx.Date] >= latest[sym][idx.Date]) latest[sym] = r;
  });

  let summaryParts=[];
  SYMBOLS.forEach(sym=>{
    const el=document.getElementById(`signal-${sym}`);
    const r=latest[sym];
    if(!r){ 
      el.innerHTML='<b>建議：</b> 暫無動作';
      summaryParts.push(`${sym} HOLD`);
    } else {
      const sig=r[idx.Signal]||'HOLD';
      if(sig==='BUY' || sig==='SELL'){
        el.innerHTML=`
          <b>建議：</b> ${sig}<br>
          <b>入場：</b> ${num(r[idx.Entry])}<br>
          <b>停損：</b> ${num(r[idx.Stop])}<br>
          <b>停利：</b> ${num(r[idx.TakeProfit])}<br>
          <b>股數：</b> ${r[idx.Shares]||'-'}
        `;
        summaryParts.push(`${sym} ${sig}`);
      } else {
        el.innerHTML='<b>建議：</b> 暫無動作';
        summaryParts.push(`${sym} HOLD`);
      }
    }
  });
  document.getElementById('summary').textContent="今日建議："+summaryParts.join(" ｜ ");
}

function num(x){ const f=parseFloat(x); return isFinite(f)? f.toFixed(2):'-'; }

async function drawNews(){
  const rows=await csv(newsCSV);
  if(!rows.length)return;
  const data=rows.slice(1);
  const box=document.getElementById('news-list');
  box.innerHTML=data.slice(0,15).map(r=>{
    const [title,date,source,summary,sent]=r;
    return `<div class="news-item">
      <a href="#" onclick="return false">${escapeHtml(title||'—')}</a>
      <div class="news-meta">${escapeHtml(date||'')}${source?' · '+escapeHtml(source):''}${sent?' · '+escapeHtml(sent):''}</div>
      <div class="summary">${escapeHtml(summary||'')}</div>
    </div>`;
  }).join('');
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

async function boot(){ buildCards(); await drawCharts(); await drawSignals(); await drawNews(); }
document.getElementById('refreshBtn').addEventListener('click', boot);
boot();
</script>
</body>
</html>
