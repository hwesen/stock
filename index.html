<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>股票監控看板</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --card-gap: 20px; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; color:#111; background:#f9f9f9; }
    h1 { text-align:center; margin: 10px 0 12px; }
    #summary { text-align:center; font-weight:600; margin-bottom:20px; color:#333; }
    .grid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--card-gap);
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 28px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    .card {
      background:white;
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    .card h3 { margin:0 0 10px; font-size:16px; }
    .analysis, .news {
      max-width: 1000px;
      margin: 0 auto 28px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .analysis h2, .news h2 {
      margin-bottom: 12px;
      text-align: center;
    }
    .analysis p, .news p {
      margin: 6px 0;
      line-height: 1.6;
    }
    .stock-title {
      font-weight: bold;
      color: #333;
    }
    .news a {
      color: #0066cc;
      text-decoration: none;
    }
    .news a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>股票監控看板</h1>
  <div id="summary">今日建議載入中...</div>

  <div class="grid" id="stockGrid"></div>

  <!-- 分析說明 -->
  <div class="analysis">
    <h2>📊 分析說明</h2>
    <div id="analysisContent"></div>
  </div>

  <!-- 新聞摘要 -->
  <div class="news">
    <h2>📰 最新消息摘要</h2>
    <div id="newsContent">載入中...</div>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwTihz3-zh_A-sOX9yhRehETUNqsgOFCAQljpKRfj7R5P6SSUpyJezo9bremy7JiYkyWQ/exec"; // ← 換成你部署的 doGet 網址

    async function loadSignals() {
      try {
        const res = await fetch(WEBAPP_URL + "?type=signals");
        const stocks = await res.json();

        // === 更新 Summary ===
        const summary = stocks.map(s => `${s.symbol} ${s.signal}`).join(" ｜ ");
        document.getElementById("summary").innerText = "今日建議：" + summary;

        // === 更新股票卡片 ===
        const grid = document.getElementById("stockGrid");
        grid.innerHTML = "";
        stocks.forEach(stock => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <h3>${stock.symbol}</h3>
            <p>Signal：${stock.signal}</p>
            <p>Regime：${stock.regime}</p>
            <p>Entry：${stock.entry || '-'}</p>
            <p>Stop：${stock.stop || '-'}</p>
            <p>TP：${stock.takeProfit || '-'}</p>
            <canvas id="chart-${stock.symbol}" height="120"></canvas>
          `;
          grid.appendChild(card);

          // 繪製均線簡單圖
          const labels = ["SMA20","SMA50","SMA200"];
          const data = [stock.sma20, stock.sma50, stock.sma200];
          new Chart(document.getElementById(`chart-${stock.symbol}`), {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: "均線值",
                data: data,
                backgroundColor: "rgba(75,192,192,0.5)"
              }]
            },
            options: { responsive: true, plugins:{ legend:{display:false} } }
          });
        });

        // === 更新分析說明 ===
        const analysisDiv = document.getElementById("analysisContent");
        analysisDiv.innerHTML = "";

        stocks.forEach(stock => {
          let text = "";
          switch(stock.signal) {
            case "HOLD":
              text = `${stock.symbol} 現價 ${stock.entry || "N/A"}，屬於 ${stock.regime} 趨勢，暫無明顯突破訊號，建議觀望持有。`;
              break;
            case "BUY":
              text = `${stock.symbol} 出現買進訊號（RSI=${stock.rsi}），建議進場價 ${stock.entry}，停損 ${stock.stop}，目標價 ${stock.takeProfit}。`;
              break;
            case "SELL":
              text = `${stock.symbol} 走勢轉弱，出現賣出訊號，可考慮獲利了結或停損出場。`;
              break;
            default:
              text = `${stock.symbol} 無明確訊號。`;
          }
          if (stock.note) text += `（${stock.note}）`;

          const p = document.createElement("p");
          p.innerHTML = `<span class="stock-title">${stock.symbol}：</span> ${text}`;
          analysisDiv.appendChild(p);
        });

      } catch (err) {
        document.getElementById("summary").innerText = "⚠️ 無法載入資料";
        console.error(err);
      }
    }

    async function loadNews() {
      try {
        const res = await fetch(WEBAPP_URL + "?type=news");
        const news = await res.json();

        const newsDiv = document.getElementById("newsContent");
        newsDiv.innerHTML = "";

        news.forEach(item => {
          const p = document.createElement("p");

          const a = document.createElement("a");
          a.href = item.url.startsWith("http") ? item.url : "https://" + item.url;
          a.target = "_blank";
          a.innerText = item.title || "[無標題]";

          p.appendChild(a);
          if (item.summary) {
            const span = document.createElement("span");
            span.innerText = " - " + item.summary;
            p.appendChild(span);
          }
          newsDiv.appendChild(p);
        });
      } catch (err) {
        document.getElementById("newsContent").innerText = "⚠️ 無法載入新聞";
        console.error(err);
      }
    }

    // 初始化
    loadSignals();
    loadNews();
  </script>
</body>
</html>
