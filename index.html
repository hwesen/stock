<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æŠ•è³‡è³‡è¨Š BI Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background: #f5f7fa; margin: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }
    #summary { text-align:center; font-weight:bold; font-size:18px; margin-bottom:20px; }
    .grid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 30px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }
    .card {
      background:white;
      border-radius:12px;
      padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .card h3 { margin:0 0 10px; font-size:16px; }
    .analysis, .news {
      max-width: 1000px;
      margin: 0 auto 28px;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .analysis h2, .news h2 {
      margin-bottom: 12px;
      text-align: center;
    }
    .analysis p, .news p {
      margin: 6px 0;
      line-height: 1.6;
    }
    .stock-title {
      font-weight: bold;
      color: #333;
    }
    .news a {
      color: #0066cc;
      text-decoration: none;
    }
    .news a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<h1>ğŸ“Š æŠ•è³‡è³‡è¨Š BI Dashboard</h1>
<div id="summary">ä»Šæ—¥å»ºè­°è¼‰å…¥ä¸­...</div>

<!-- è‚¡ç¥¨å¡ç‰‡ -->
<div class="grid" id="stockGrid"></div>

<!-- åˆ†æèªªæ˜ -->
<div class="analysis">
  <h2>ğŸ“Š åˆ†æèªªæ˜</h2>
  <div id="analysisContent"></div>
</div>

<!-- æ–°èæ‘˜è¦ -->
<div class="news">
  <h2>ğŸ“° æœ€æ–°æ¶ˆæ¯æ‘˜è¦</h2>
  <div id="newsContent">è¼‰å…¥ä¸­...</div>
</div>

<script>
  // æ›æˆä½ éƒ¨ç½²çš„ Google Apps Script WebApp URL
  const WEBAPP_URL = "https://script.google.com/macros/s/ä½ çš„WebAppID/exec";

  async function loadSignals() {
    try {
      const res = await fetch(WEBAPP_URL + "?type=signals");
      const stocks = await res.json();

      // åˆ†é–‹å¤§ç›¤ SPY èˆ‡å€‹è‚¡
      const marketRow = stocks.find(s => s.symbol === "SPY");
      const stockRows = stocks.filter(s => s.symbol !== "SPY");

      // === Summary ===
      let summaryText = "";
      if (marketRow) {
        summaryText = `å¤§ç›¤ (${marketRow.symbol}) ç‹€æ…‹ï¼š${marketRow.regime} ï½œ `;
      }
      summaryText += stockRows.map(s => `${s.symbol} ${s.signal}`).join(" ï½œ ");
      document.getElementById("summary").innerText = "ä»Šæ—¥å»ºè­°ï¼š" + summaryText;

      // === è‚¡ç¥¨å¡ç‰‡ ===
      const grid = document.getElementById("stockGrid");
      grid.innerHTML = "";
      stockRows.forEach(stock => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${stock.symbol}</h3>
          <p>Signalï¼š${stock.signal}</p>
          <p>Regimeï¼š${stock.regime}</p>
          <p>Entryï¼š${stock.entry || '-'}</p>
          <p>Stopï¼š${stock.stop || '-'}</p>
          <p>TPï¼š${stock.takeProfit || '-'}</p>
          <canvas id="chart-${stock.symbol}" height="120"></canvas>
        `;
        grid.appendChild(card);

        // å‡ç·šå°åœ–
        const labels = ["SMA20","SMA50","SMA200"];
        const data = [stock.sma20, stock.sma50, stock.sma200];
        new Chart(document.getElementById(`chart-${stock.symbol}`), {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: "å‡ç·šå€¼",
              data: data,
              backgroundColor: "rgba(75,192,192,0.5)"
            }]
          },
          options: { responsive: true, plugins:{ legend:{display:false} } }
        });
      });

      // === åˆ†æèªªæ˜ ===
      const analysisDiv = document.getElementById("analysisContent");
      analysisDiv.innerHTML = "";

      if (marketRow) {
        const marketP = document.createElement("p");
        marketP.innerHTML = `<span class="stock-title">å¤§ç›¤ (${marketRow.symbol})ï¼š</span> ä»Šæ—¥å±¬æ–¼ ${marketRow.regime} ç‹€æ…‹ã€‚`;
        analysisDiv.appendChild(marketP);
      }

      stockRows.forEach(stock => {
        let text = "";
        switch(stock.signal) {
          case "HOLD":
            text = `${stock.symbol} ç¾åƒ¹ ${stock.entry || "N/A"}ï¼Œå±¬æ–¼ ${stock.regime} è¶¨å‹¢ï¼Œæš«ç„¡çªç ´è¨Šè™Ÿï¼Œå»ºè­°è§€æœ›ã€‚`;
            break;
          case "BUY":
            text = `${stock.symbol} å‡ºç¾è²·é€²è¨Šè™Ÿï¼ˆRSI=${stock.rsi}ï¼‰ï¼Œå»ºè­°é€²å ´åƒ¹ ${stock.entry}ï¼Œåœæ ${stock.stop}ï¼Œç›®æ¨™åƒ¹ ${stock.takeProfit}ã€‚`;
            break;
          case "SELL":
            text = `${stock.symbol} èµ°å‹¢è½‰å¼±ï¼Œå‡ºç¾è³£å‡ºè¨Šè™Ÿï¼Œå¯è€ƒæ…®å‡ºå ´ã€‚`;
            break;
          default:
            text = `${stock.symbol} ç„¡æ˜ç¢ºè¨Šè™Ÿã€‚`;
        }
        if (stock.note) text += `ï¼ˆ${stock.note}ï¼‰`;

        const p = document.createElement("p");
        p.innerHTML = `<span class="stock-title">${stock.symbol}ï¼š</span> ${text}`;
        analysisDiv.appendChild(p);
      });

    } catch (err) {
      document.getElementById("summary").innerText = "âš ï¸ ç„¡æ³•è¼‰å…¥è³‡æ–™";
      console.error(err);
    }
  }

  async function loadNews() {
    try {
      const res = await fetch(WEBAPP_URL + "?type=news");
      const news = await res.json();

      const newsDiv = document.getElementById("newsContent");
      newsDiv.innerHTML = "";

      news.forEach(item => {
        const p = document.createElement("p");

        const a = document.createElement("a");
        a.href = item.url.startsWith("http") ? item.url : "https://" + item.url;
        a.target = "_blank";
        a.innerText = item.title || "[ç„¡æ¨™é¡Œ]";

        p.appendChild(a);
        if (item.summary) {
          const span = document.createElement("span");
          span.innerText = " - " + item.summary;
          p.appendChild(span);
        }
        newsDiv.appendChild(p);
      });
    } catch (err) {
      document.getElementById("newsContent").innerText = "âš ï¸ ç„¡æ³•è¼‰å…¥æ–°è";
      console.error(err);
    }
  }

  // åˆå§‹åŒ–
  loadSignals();
  loadNews();
</script>

</body>
</html>
