<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>股票監控看板</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align:center; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    canvas { background:#fff; border:1px solid #ccc; padding:10px; }
  </style>
</head>
<body>
  <h1>股票監控看板</h1>

  <div class="grid">
    <canvas id="chart-BABA"></canvas>
    <canvas id="chart-UNH"></canvas>
    <canvas id="chart-TSLA"></canvas>
    <canvas id="chart-NVDA"></canvas>
  </div>

<script>
const SHEET_ID = "16Ez6rBX12fI0zm7EIz01UQiiXRNWDBtJwH65TlWiPI0"; 
const pricesCSV = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Prices`;

async function csv(url){
  const t = await (await fetch(url,{cache:'no-store'})).text();
  return t.trim().split('\n').map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'')));
}

async function drawCharts(){
  const rows = await csv(pricesCSV);
  const headers = rows[0];
  const data = rows.slice(1);

  const grouped = {};
  data.forEach(r=>{
    const [symbol,date,price,open,high,low,prevClose,volume] = r;
    if(!grouped[symbol]) grouped[symbol]={dates:[],closes:[],volumes:[]};
    grouped[symbol].dates.push(date);
    grouped[symbol].closes.push(parseFloat(price));
    grouped[symbol].volumes.push(parseInt(volume||0));
  });

  Object.keys(grouped).forEach(sym=>{
    const ctx = document.getElementById(`chart-${sym}`).getContext('2d');
    new Chart(ctx,{
      type:'bar',
      data:{
        labels: grouped[sym].dates.slice(-30), // 最近30天
        datasets:[
          {
            type:'line',
            label:`${sym} Close`,
            data: grouped[sym].closes.slice(-30),
            borderColor:'blue',
            yAxisID:'y'
          },
          {
            type:'bar',
            label:`${sym} Volume`,
            data: grouped[sym].volumes.slice(-30),
            backgroundColor:'rgba(0,0,0,0.2)',
            yAxisID:'y1'
          }
        ]
      },
      options:{
        responsive:true,
        scales:{
          y:{position:'left',title:{display:true,text:'Price'}},
          y1:{position:'right',title:{display:true,text:'Volume'},grid:{drawOnChartArea:false}}
        }
      }
    });
  });
}

drawCharts();
</script>
</body>
</html>
